## there are more variables to be processed; depending on the dataset

#variable	count
#studyYear	1471
#studyName	1471
#studyDesign	1471
#studyDescription	1471
#studyDbId	1471
#rowNumber	1471
#replicate	1471
#programName	1471
#programDescription	1471
#programDbId	1471
#plotWidth	1471
#plotNumber	1471
#plotLength	1471
#plantNumber	1471
#plantingDate	1471
#plantedSeedlotTransactionWeight	1471
#plantedSeedlotTransactionDescription	1471
#plantedSeedlotTransactionCount	1471
#plantedSeedlotStockUniquename	1471
#plantedSeedlotStockDbId	1471
#plantedSeedlotCurrentWeightGram	1471
#plantedSeedlotCurrentCount	1471
#plantedSeedlotBoxName	1471
#observationUnitName	1471
#observationUnitDbId	1471
#observationLevel	1471
#notes	1471
#locationName	1471
#locationDbId	1471
#harvestDate	1471
#germplasmSynonyms	1471
#germplasmName	1471
#germplasmDbId	1471
#fieldTrialIsPlannedToCross	1471
#fieldTrialIsPlannedToBeGenotyped	1471
#fieldSize	1471
#entryType	1471
#colNumber	1471
#blockNumber	1471
#availableGermplasmSeedlotUniquenames	1471
#fresh.storage.root.weight.per.plot.CO_334.0000012	1023
#root.number.counting.CO_334.0000011	1021
#plant.stands.harvested.counting.CO_334.0000010	938
#cassava.mosaic.disease.severity.3.month.evaluation.CO_334.0000192	896
#cassava.mosaic.disease.severity.1.month.evaluation.CO_334.0000191	843
#rotted.storage.root.counting.CO_334.0000084	842
#cassava.mosaic.disease.incidence.3.month.evaluation.CO_334.0000196	840
#fresh.shoot.weight.measurement.in.kg.per.plot.CO_334.0000016	833
#cassava.mosaic.disease.incidence.1.month.evaluation.CO_334.0000195	810
#cassava.bacterial.blight.severity.3.month.evaluation.CO_334.0000175	807
#sprouting.proportion.CO_334.0000008	805
#storage.root.size.visual.rating.1.7.CO_334.0000019	802
#dry.matter.content.percentage.CO_334.0000092	760
#cassava.bacterial.blight.incidence.3.month.evaluation.CO_334.0000178	744
#taste.of.boiled.root.rating.1.3.CO_334.0000085	665
#fresh.root.yield.CO_334.0000013	656
#cassava.mosaic.disease.severity.6.month.evaluation.CO_334.0000194	653
#initial.vigor.assessment.1.7.CO_334.0000009	642
#root.neck.length.visual.rating.0.7.CO_334.0000022	606
#poundability.assessment.0.4.CO_334.0000074	598
#cassava.mosaic.disease.incidence.6.month.evaluation.CO_334.0000198	597
#boiled.storage.root.color.visual.1.3.CO_334.0000114	595
#ease.of.peeling.root.cortex.visual.rating.1.3.CO_334.0000308	574
#cassava.bacterial.blight.severity.6.month.evaluation.CO_334.0000176	571
#cassava.bacterial.blight.incidence.6.month.evaluation.CO_334.0000179	526
#cassava.green.mite.severity.first.evaluation.CO_334.0000189	500
#storage.root.shape.visual.rating.1.6.CO_334.0000020	490
#harvest.index.variable.CO_334.0000015	467
#dry.yield.CO_334.0000014	454
#storage.root.cortex.color.visual.rating.1.4.CO_334.0000115	447
#top.yield.CO_334.0000017	436
#cassava.green.mite.severity.second.evaluation.CO_334.0000190	396
#storage.root.pulp.color.visual.rating.1.3.CO_334.0000021	389
#cassava.anthractnose.disease.severity.in.6.month.CO_334.0000184	384
#storage.root.periderm.color.visual.rating.1.4.CO_334.0000064	373
#cassava.anthractnose.disease.incidence.in.6.month.CO_334.0000181	363
#fibre.content.estimation.in.percentage.CO_334.0000067	321
#sprout.count.at.one.month.CO_334.0000213	267
#hydrogen.cyanide.potential.picrate.method.1.9.CO_334.0000091	257
#total.carotenoid.by.chart.1.8.CO_334.0000161	248
#cassava.anthractnose.disease.severity.in.9.month.CO_334.0000185	245
#cassava.anthractnose.disease.incidence.in.9.month.CO_334.0000182	230
#sprout.count.at.three.month.CO_334.0000214	191
#number.of.planted.stakes.per.plot.counting.CO_334.0000159	164
#plant.height.measurement.in.cm.CO_334.0000018	157
#first.apical.branch.height.measurement.in.cm.CO_334.0000106	156
#plant.architecture.visual.rating.1.5.CO_334.0000099	155
#root.weight.in.water.CO_334.0000158	151
#root.weight.in.air.CO_334.0000157	151
#sprout.count.at.six.month.CO_334.0000215	138
#proportion.lodged.plants.in.percentage.CO_334.0000094	136
#dry.matter.content.by.specific.gravity.method.CO_334.0000160	120
#cassava.brown.streak.disease.root.severity.12.month.evaluation.CO_334.0000201	120
#marketable.root.weight.measurement.in.kg.CO_334.0000131	114
#marketable.root.number.counting.CO_334.0000169	110
#non.marketable.root.weight.measurement.in.kg.CO_334.0000132	109
#non.marketable.root.number.counting.CO_334.0000168	101
#ease.of.peeling.root.cortex.visual.rating.1.7.CO_334.0000116	94
#total.carotenoid.by.iCheck.method.CO_334.0000162	90
#specific.gravity.CO_334.0000163	87
#sprout.count.at.nine.month.CO_334.0000216	84
#dry.matter.visual.rating.1.3.CO_334.0002012	74
#yield.visual.rating.1.3.CO_334.0002011	65
#petiole.color.visual.rating.1.9.CO_334.0000023	65
#central.leaf.shape.visual.rating.1.10.CO_334.0000119	65
#first.fully.expanded.leaf.color.visual.rating.1.9.CO_334.0000102	64
#cassava.mosaic.disease.severity.9.month.evaluation.CO_334.0000193	64
#cassava.brown.streak.disease.leaf.severity.9.month.evaluation.CO_334.0000206	63
#staygreen.visual.scale.1.9.CO_334.0000224	60
#root.flesh.color.visual.rating.1.3.CO_334.0000222	60
#cassava.mosaic.disease.incidence.9.month.evaluation.CO_334.0000197	60
#cassava.brown.streak.disease.leaf.severity.6.month.evaluation.CO_334.0000205	59
#cassava.brown.streak.disease.leaf.severity.3.month.evaluation.CO_334.0000204	59
#cassava.brown.streak.disease.leaf.incidence.6.month.evaluation.CO_334.0000209	59
#cassava.brown.streak.disease.leaf.incidence.3.month.evaluation.CO_334.0000208	59
#cassava.brown.streak.disease.leaf.incidence.9.month.evaluation.CO_334.0000210	55
#stem.number.counting.CO_334.0000129	54
#cassava.brown.streak.disease.leaf.severity.1.month.evaluation.CO_334.0000203	54
#cassava.brown.streak.disease.leaf.incidence.1.month.evaluation.CO_334.0000207	54
#cassava.green.mite.incidence.first.evaluation.CO_334.0000187	50
#apical.pubescence.visual.rating.0.2.CO_334.0000309	48
#cassava.green.mite.incidence.second.evaluation.CO_334.0000188	44
#unexpanded.apical.leaf.color.visual.rating.1.9.CO_334.0000101	41
#cassava.bacterial.blight.severity.9.month.evaluation.CO_334.0000177	40
#branching.level.counting.CO_334.0000079	37
#cassava.bacterial.blight.incidence.9.month.evaluation.CO_334.0000180	35
#cassava.anthractnose.disease.severity.in.3.month.CO_334.0000218	33
#cassava.green.mite.severity.first.evaluation.month.8.COMP.0000111	24
#cassava.green.mite.severity.first.evaluation.month.6.COMP.0000110	24
#cassava.green.mite.severity.first.evaluation.month.4.COMP.0000109	24
#cassava.green.mite.severity.first.evaluation.month.2.COMP.0000108	24
#cassava.green.mite.incidence.first.evaluation.month.8.COMP.0000107	24
#cassava.green.mite.incidence.first.evaluation.month.6.COMP.0000106	24
#cassava.green.mite.incidence.first.evaluation.month.4.COMP.0000105	24
#cassava.green.mite.incidence.first.evaluation.month.2.COMP.0000104	24
#initial.plant.vigor.assessment.1.5.CO_334.0000220	23
#cassava.anthractnose.disease.incidence.in.3.month.CO_334.0000219	16
#stump.weight.measurement.in.kg.CO_334.0000135	13
#stem.weight.measurement.in.kg.CO_334.0000127	12
#sprout.count.at.twelve.month.CO_334.0000217	11
#leaf.retention.visual.rating.1.5.CO_334.0000048	10
#cassava.mealy.bug.severity.by.visual.rating.1.5.CO_334.0000034	8
#beta.carotene.content.ug.g.CO_334.0000095	8
#red.spider.mite.severity...visual.1.5.CO_334.0000044	6
#young.stem.growth.habit.visual.rating.1.2.CO_334.0000104	5
#Typhlodromalus.aripo...visual.1.0.CO_334.0000153	5
#starch.content.percentage.CO_334.0000071	5
#hairiness.visual.observation.1.5.CO_334.0000237	5
#gari.weight.after.drying.in.kg.g.CO_334.0000246	5
#cassava.brown.streak.disease.root.incidence.12.month.evaluation.CO_334.0000202	5
#bemesia.tabaci.nymphs.yellow...counting.CO_334.0000150	5
#bemesia.tabaci.nymphs.by.counting.month.3.COMP.0000173	5
#bemesia.tabaci.nymphs.black...counting.CO_334.0000151	5
#bemesia.tabaci.adult.by.counting.CO_334.0000087	5
#apical.pubescence.visual.rating.0.7.CO_334.0000026	5
#hydrogen.cyanide.potential.enzymatic.method.CO_334.0000076	4
#gari.content.g.kg.CO_334.0000096	4
#stock.weight.measurement.in.kg.CO_334.0000170	3
#root.evaluation.scaled.1.5.CO_334.0000228	3
#flower.visual.rating.0.1.CO_334.0000111	3
#total.carotenoid.content.in.ug.g.CO_334.0000073	2
#stem.diameter.measurement.in.cm.CO_334.0000257	2
#stem.color.visual.scoring.1.4.CO_334.0000062	2
#plant.shape.visual.assessment.1.4.CO_334.0000264	2
#petiole.length.visual.rating.0.7.CO_334.0000024	2
#dry.weight.of.biomass.in.kg.CO_334.0002046	2
#cassava.mosaic.disease.severity.12.month.evaluation.CO_334.0000199	2
#X.9	1
#X.8	1
#X.7	1
#X.6	1
#X.5	1
#X.4	1
#X.3	1
#X.20	1
#X.2	1
#X.19	1
#X.18	1
#X.17	1
#X.16	1
#X.15	1
#X.14	1
#X.13	1
#X.12	1
#X.11	1
#X.10	1
#X.1	1
#X	1
#weibull.fit.shape.variable.week.46.COMP.0000117	1
#weibull.fit.shape.variable.week.38.COMP.0000116	1
#weibull.fit.shape.variable.week.33.COMP.0000115	1
#weibull.fit.scale.variable.week.46.COMP.0000114	1
#weibull.fit.scale.variable.week.38.COMP.0000113	1
#weibull.fit.scale.variable.week.33.COMP.0000112	1
#Typhlodromalus.aripo...visual.1.0.month.6.COMP.0000165	1
#Trough	1
#title	1
#tip.shoot.weight.measurement.in.kg.CO_334.0000130	1
#Tab	1
#subject.agrovoc	1
#subject	1
#source.file	1
#source.date	1
#source	1
#Setback	1
#root.surface.texture.visual.rating.1.7.CO_334.0000054	1
#rights	1
#relation	1
#plot.volume.in.m3.week.46.COMP.0000091	1
#plot.volume.in.m3.week.38.COMP.0000090	1
#plot.volume.in.m3.week.33.COMP.0000089	1
#plant.height.per.plot.in.m.week.46.COMP.0000088	1
#plant.height.per.plot.in.m.week.38.COMP.0000087	1
#plant.height.per.plot.in.m.week.33.COMP.0000086	1
#Percentage_DM	1
#Peak_Visc	1
#Peak_Time	1
#Pasting_Temp	1
#Measurement	1
#Location	1
#leaf.lobe.number.counting.CO_334.0000082	1
#language	1
#identifier	1
#ID	1
#hairiness.visual.observation.1.5.month.6.COMP.0000171	1
#format	1
#flowering.ability.visual.assessment.0.3.CO_334.0000233	1
#Final_Visc	1
#female.flower.incidence.in.proportion.CO_334.0000235	1
#description_abstract	1
#data_type	1
#creator	1
#coverage.country	1
#coverage	1
#contributors	1
#Column	1
#Clone	1
#cassava.mosaic.disease.incidence.12.month.evaluation.CO_334.0000200	1
#cassava.mealy.bug.severity.by.visual.rating.1.5.month.6.COMP.0000168	1
#cassava.mealy.bug.incidence.by.ratio.CO_334.0000041	1
#Breakdown	1
#branching.habit.visual.observation.1.4.CO_334.0000140	1
#Branch.height.CO_334.0000293	1
#bemesia.tabaci.nymphs.yellow...counting.month.6.COMP.0000162	1
#bemesia.tabaci.nymphs.by.counting.month.6.COMP.0000174	1
#bemesia.tabaci.nymphs.black...counting.month.6.COMP.0000156	1
#bemesia.tabaci.adult.by.counting.month.6.COMP.0000153	1



process_cassava <- function(ff, location=NULL, adm1=NULL) {

	f <- grep("\\.csv$", ff, value=TRUE)
	r <- read.csv(f)
	fd <- dirname(f)
	fj <- file.path(fd, paste0(basename(fd), ".json"))
	m <- jsonlite::fromJSON(fj)$result
	
	
	d <- data.frame(
		longitude = as.numeric(m$coverage_y), #!!
		latitude = as.numeric(m$coverage_x),
		geo_from_source = TRUE,
		country = m$coverage_country,
		planting_date = r$plantingDate,
		harvest_date = r$harvestDate,
		year = r$studyYear,
		plot_length = as.numeric(r$plotLength),
		plot_width = as.numeric(r$plotWidth),
		location = carobiner::fix_name(r$locationName, "title"),
		variety = trimws(r$germplasmName),
		variety_alt = trimws(as.character(r$germplasmSynonyms)),
		variety_code = as.character(r$germplasmDbId),
		rep = r$replicate,
		trial_id = r$studyName,
		on_farm = FALSE
	)
	if (!is.null(r$fresh.root.yield.CO_334.0000013)) {
		d$fwy_storage <- d$yield <- 1000 * r$fresh.root.yield.CO_334.0000013
	} else if (!is.null(r$fresh.storage.root.weight.per.plot.CO_334.0000012)) {
		d$fwy_storage <- d$yield <- 1000 * r$fresh.storage.root.weight.per.plot.CO_334.0000012 / (d$plot_length * d$plot_width)
	}
	if (!is.null(r$fresh.shoot.weight.measurement.in.kg.per.plot.CO_334.0000016)) {
		d$fwy_residue <- 1000 * r$fresh.shoot.weight.measurement.in.kg.per.plot.CO_334.0000016 / (d$plot_length * d$plot_width)	
	}
	d$dmy_storage <- r$dry.yield.CO_334.0000014
	if (!is.null(r$dry.matter.content.percentage.CO_334.0000092)) {
		yield_moisture <- 100 - r$dry.matter.content.percentage.CO_334.0000092
	}
	d$harvest_index <- r$harvest.index.variable.CO_334.0000015
	d$country[grepl("Tanzania", d$country, ignore.case=TRUE)] <- "Tanzania"
	d$country[d$country == "DRC"] <- "Democratic Republic of the Congo"
	d$variety_alt[d$variety_alt == ""] <- NA


	d$planting_date <- carobiner:::eng_months_to_nr(d$planting_date) |> as.Date() |> as.character()
	d$harvest_date <- carobiner:::eng_months_to_nr(d$harvest_date) |> as.Date() |> as.character()
	if (!is.null(location)) {
		d$location <- location
		d$adm1 <- adm1
		d$on_farm <- TRUE
	}


	vdis <- c("cassava.mosaic.disease.incidence.1.month.evaluation.CO_334.0000195", "cassava.mosaic.disease.incidence.3.month.evaluation.CO_334.0000196", "cassava.mosaic.disease.incidence.6.month.evaluation.CO_334.0000198", "cassava.mosaic.disease.severity.1.month.evaluation.CO_334.0000191", "cassava.mosaic.disease.severity.3.month.evaluation.CO_334.0000192", "cassava.mosaic.disease.severity.6.month.evaluation.CO_334.0000194", "cassava.mosaic.disease.severity.12.month.evaluation.CO_334.0000199", "cassava.bacterial.blight.severity.3.month.evaluation.CO_334.0000175", "cassava.bacterial.blight.severity.6.month.evaluation.CO_334.0000176", "cassava.bacterial.blight.incidence.6.month.evaluation.CO_334.0000179")

	i <- match(vdis, names(r))
	tmrecs <- NULL
	if (any(!is.na(i))) {
		vnms <- vdis[which(!is.na(i))]
		dd <- r[, vnms, drop=FALSE]
		d$record_id <- dd$record_id <- 1:nrow(d)
		DAP <- rep(NA, ncol(dd)-1)
		DAP[grepl("1.month", vnms)] <- 30
		DAP[grepl("3.month", vnms)] <- 91
		DAP[grepl("6.month", vnms)] <- 182
		DAP[grepl("11.month", vnms)] <- 365
		DAP <- as.integer(DAP)
		dates <- NULL
		if (!is.na(d$planting_date[1])) {
			dates <- as.character(as.Date(d$planting_date[1]) + DAP)
		}
		diseases <- rep("mosaic", length(vnms))
		diseases[grep("blight", vnms)] <- "bacterial blight"
		incidence <- severity <- NULL
		sev <- grepl("severity", names(dd))	
		if (any(sev)) {
			ddi <- dd[, c("record_id", names(dd)[sev])]
			severity <- reshape(ddi, direction="long", varying=vnms[sev], v.names="disease_severity", timevar="step")
			severity$time <- dates[sev][severity$step]
			severity$DAP <- DAP[sev][severity$step]
			severity$diseases <- diseases[sev]
			severity$disease_severity <- as.character(severity$disease_severity)
			severity$severity_scale <- as.character(NA) #perhaps "1-4?  
			severity <- na.omit(severity)
			if (nrow(severity) == 0) severity <- NULL
		}
		inc <- grepl("incidence", names(dd))	
		if (any(inc)) {
			ddi <- dd[, c("record_id", names(dd)[inc])]
			incidence <- reshape(ddi, direction="long", varying=vnms[inc], v.names="disease_incidence", timevar="step")
			incidence$time <- dates[inc][incidence$step]
			incidence$DAP <- DAP[inc][incidence$step]
			incidence$diseases <- diseases[inc]
			incidence$disease_incidence <- as.character(incidence$disease_incidence)
			incidence <- na.omit(incidence)
			if (nrow(incidence) == 0) incidence <- NULL
			
		}
		tmrecs <- carobiner::bindr(severity, incidence)
		if (!is.null(tmrecs)) {
			tmrecs$id <- tmrecs$step <- NULL      
		}
		d[vnms] <-  NULL
	}


	if (all(is.na(d$planting_date))) d$planting_date <- as.character(d$year)
	d$year <- NULL

	d$is_survey <- FALSE
	d$crop <- "cassava"
	d$yield_part <- "roots"
	d$N_fertilizer <- d$P_fertilizer <- d$K_fertilizer <- as.numeric(NA)
	d$irrigated <- NA

	if (is.null(tmrecs)) {
		i <- duplicated(d[, names(d) != "record_id"])
		d <- d[!i, ]
	}
	
	list(records=d, timerecs=tmrecs)
}


